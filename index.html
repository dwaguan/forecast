<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预测平台</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .tab-btn { padding: 10px; margin: 5px; cursor: pointer; border: none; background: #ddd; }
        .tab-btn.active { background: #007bff; color: white; }
        .tab-content { display: none; margin-top: 20px; }
        .prediction-item { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; margin-top: 10px; }
        .status-pending { background: #ffc107; color: #000; }
        .status-today { background: #17a2b8; color: #fff; }
        .status-overdue { background: #dc3545; color: #fff; }
        .status-success { background: #28a745; color: #fff; }
        .status-fail { background: #6c757d; color: #fff; }
        .like-btn.liked { color: red; }
        .actions button { margin-right: 8px; }
    </style>
</head>
<body>
    <h1>📊 预测平台</h1>
    <div>
        <button class="tab-btn active" onclick="switchTab('feed')">🌍 全部预测</button>
        <button class="tab-btn" onclick="switchTab('my')">🧑‍💻 我的预测</button>
        <button class="tab-btn" onclick="switchTab('new')">➕ 发布预测</button>
    </div>

    <div id="feed-tab" class="tab-content" style="display: block;">
        <div>
            筛选:
            <select id="category-filter" onchange="filterPredictions()">
                <option value="">全部</option>
                <option value="finance">📈 金融</option>
                <option value="politics">🏛️ 政治</option>
                <option value="sports">⚽ 体育</option>
                <option value="tech">🚀 科技</option>
                <option value="climate">🌡️ 气候</option>
                <option value="other">🌟 其他</option>
            </select>
            <select id="status-filter" onchange="filterPredictions()">
                <option value="">全部状态</option>
                <option value="pending">未到期</option>
                <option value="due">今日到期</option>
                <option value="overdue">已过期</option>
                <option value="verified">已验证</option>
            </select>
            <select id="sort-filter" onchange="filterPredictions()">
                <option value="newest">最新</option>
                <option value="oldest">最早</option>
                <option value="likes">点赞最多</option>
                <option value="confidence">信心最高</option>
            </select>
        </div>
        <div id="global-predictions"></div>
    </div>

    <div id="my-tab" class="tab-content">
        <div id="my-predictions"></div>
    </div>

    <div id="new-tab" class="tab-content">
        <h2>➕ 发布新的预测</h2>
        <input type="text" id="prediction-content" placeholder="你的预测内容" style="width: 100%; margin-bottom: 10px;"><br>
        截止日期: <input type="date" id="prediction-due" style="margin-bottom: 10px;"><br>
        信心: <input type="number" id="prediction-confidence" min="1" max="100" value="50" style="width: 60px;">%<br>
        分类:
        <select id="prediction-category">
            <option value="finance">📈 金融</option>
            <option value="politics">🏛️ 政治</option>
            <option value="sports">⚽ 体育</option>
            <option value="tech">🚀 科技</option>
            <option value="climate">🌡️ 气候</option>
            <option value="other">🌟 其他</option>
        </select><br><br>
        <button onclick="submitPrediction()">提交预测</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCtShgB65TLqik_EgfYA9hTIwvxnZglpdY",
          authDomain: "forecast-fab55.firebaseapp.com",
          databaseURL: "https://forecast-fab55-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "forecast-fab55",
          storageBucket: "forecast-fab55.firebasestorage.app",
          messagingSenderId: "497230817189",
          appId: "1:497230817189:web:ec30f5f5818e8fd2fc2a4c",
          measurementId: "G-T3BQTYV3FL"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let currentUser = 'user_' + Math.floor(Math.random() * 10000);
        let allPredictions = [];
        let myPredictions = [];
        let currentTab = 'feed';

        onValue(ref(database, 'predictions'), snapshot => {
            const data = snapshot.val();
            allPredictions = data ? Object.values(data) : [];
            myPredictions = allPredictions.filter(p => p.userId === currentUser);
            displayPredictions();
            displayMyPredictions();
        });

        function submitPrediction() {
            const content = document.getElementById('prediction-content').value.trim();
            const dueDate = document.getElementById('prediction-due').value;
            const confidence = parseInt(document.getElementById('prediction-confidence').value);
            const category = document.getElementById('prediction-category').value;
            if (!content || !dueDate || isNaN(confidence)) {
                alert('请完整填写所有字段');
                return;
            }
            const id = 'pred_' + Date.now();
            const newPred = {
                id,
                content,
                dueDate,
                confidence,
                category,
                createdAt: new Date().toISOString(),
                userId: currentUser,
                username: currentUser,
                likes: [],
                likesCount: 0,
                verified: false
            };
            set(ref(database, 'predictions/' + id), newPred);
            document.getElementById('prediction-content').value = '';
            alert('预测已发布');
            switchTab('my');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tabDiv => tabDiv.style.display = 'none');
            document.getElementById(`${tab}-tab`).style.display = 'block';
            if (tab === 'feed') displayPredictions();
            else if (tab === 'my') displayMyPredictions();
        }

        function displayPredictions() {
            const container = document.getElementById('global-predictions');
            if (!container) return;
            const filtered = filterAndSortPredictions(allPredictions);
            container.innerHTML = filtered.length ? filtered.map(p => createPredictionHTML(p, true)).join('') : '📭 没有预测';
        }

        function displayMyPredictions() {
            const container = document.getElementById('my-predictions');
            if (!container) return;
            container.innerHTML = myPredictions.length ? myPredictions.map(p => createPredictionHTML(p, false)).join('') : '📝 你还没有预测';
        }

        function filterPredictions() {
            if (currentTab === 'feed') displayPredictions();
        }

        function filterAndSortPredictions(predictions) {
            const cat = document.getElementById('category-filter').value;
            const stat = document.getElementById('status-filter').value;
            const sort = document.getElementById('sort-filter').value;
            let filtered = [...predictions];
            if (cat) filtered = filtered.filter(p => p.category === cat);
            if (stat) filtered = filtered.filter(p => getStatus(p) === stat);
            if (sort === 'likes') filtered.sort((a, b) => b.likesCount - a.likesCount);
            else if (sort === 'confidence') filtered.sort((a, b) => b.confidence - a.confidence);
            else if (sort === 'oldest') filtered.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            else filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            return filtered;
        }

        function getStatus(p) {
            if (p.verified) return 'verified';
            const today = new Date().toISOString().split('T')[0];
            if (p.dueDate === today) return 'due';
            if (p.dueDate < today) return 'overdue';
            return 'pending';
        }

        function createPredictionHTML(p, showActions) {
            const status = getStatus(p);
            const statusText = { pending: '未到期', due: '今日到期', overdue: '已过期', verified: p.result ? '成功' : '失败' };
            const statusClass = { pending: 'status-pending', due: 'status-today', overdue: 'status-overdue', verified: p.result ? 'status-success' : 'status-fail' };
            const liked = p.likes.includes(currentUser);
            const canVerify = !p.verified && ['due', 'overdue'].includes(status) && p.userId === currentUser;
            return `
            <div class="prediction-item">
                <h3>${p.content}</h3>
                <div>
                    👤 ${p.username} | 🎯 信心 ${p.confidence}% | 截止 ${p.dueDate} | ⏰ ${formatDateTime(p.createdAt)}
                </div>
                <div class="status-tag ${statusClass[status]}">${statusText[status]}</div>
                <div class="actions">
                    ${showActions ? `<button class="like-btn ${liked ? 'liked' : ''}" onclick="toggleLike('${p.id}')">❤️ ${p.likesCount}</button>` : ''}
                    ${canVerify ? `<button onclick="verifyPrediction('${p.id}', true)">✅ 成功</button><button onclick="verifyPrediction('${p.id}', false)">❌ 失败</button>` : ''}
                    ${p.userId === currentUser ? `<button onclick="deletePrediction('${p.id}')">🗑️ 删除</button>` : ''}
                </div>
            </div>`;
        }

        window.submitPrediction = submitPrediction;
        window.switchTab = switchTab;
        window.toggleLike = function(id) {
            const p = allPredictions.find(p => p.id === id);
            if (!p) return;
            const idx = p.likes.indexOf(currentUser);
            if (idx > -1) p.likes.splice(idx, 1);
            else p.likes.push(currentUser);
            p.likesCount = p.likes.length;
            set(ref(database, 'predictions/' + id), p);
        };

        window.verifyPrediction = function(id, result) {
            const p = allPredictions.find(p => p.id === id);
            if (!p || p.userId !== currentUser) return;
            p.verified = true;
            p.result = result;
            p.verifiedAt = new Date().toISOString();
            set(ref(database, 'predictions/' + id), p);
            alert('标记成功');
        };

        window.deletePrediction = function(id) {
            if (!confirm('确定删除?')) return;
            set(ref(database, 'predictions/' + id), null);
        };

        function formatDateTime(dateStr) {
            const d = new Date(dateStr);
            return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:${d.getMinutes()}`;
        }
    </script>
</body>
</html>
