<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction App</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
        header { background: #343a40; color: white; padding: 10px; text-align: center; }
        .tabs { display: flex; justify-content: center; background: #e9ecef; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; }
        .tab-btn.active { background: white; border-bottom: 2px solid #007bff; }
        .tab-content { padding: 20px; display: none; }
        .prediction-item { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .status-tag { padding: 5px 10px; border-radius: 5px; font-size: 12px; }
        .status-pending { background: #ffc107; }
        .status-today { background: #17a2b8; }
        .status-overdue { background: #dc3545; }
        .status-success { background: #28a745; }
        .status-fail { background: #6c757d; }
        .actions button { margin-right: 5px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .like-btn.liked { background: #ffc0cb; }
    </style>
</head>
<body>
<header>
    <h1>é¢„æµ‹å¹³å°</h1>
</header>
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('feed')">ğŸ“¢ å…¨çƒé¢„æµ‹</button>
    <button class="tab-btn" onclick="switchTab('my')">ğŸ“ æˆ‘çš„é¢„æµ‹</button>
    <button class="tab-btn" onclick="switchTab('create')">â• å‘å¸ƒé¢„æµ‹</button>
</div>
<div id="feed-tab" class="tab-content" style="display:block">
    <div id="stats">
        <span>æ€»é¢„æµ‹: <span id="total-predictions">0</span></span> |
        <span>å·²éªŒè¯: <span id="verified-predictions">0</span></span> |
        <span>ä»Šæ—¥æ–°å¢: <span id="today-predictions">0</span></span>
    </div>
    <div>
        åˆ†ç±»:
        <select id="category-filter" onchange="filterPredictions()">
            <option value="">å…¨éƒ¨</option>
            <option value="finance">è´¢ç»</option>
            <option value="politics">æ”¿æ²»</option>
            <option value="sports">ä½“è‚²</option>
            <option value="tech">ç§‘æŠ€</option>
            <option value="climate">æ°”å€™</option>
            <option value="other">å…¶ä»–</option>
        </select>
        çŠ¶æ€:
        <select id="status-filter" onchange="filterPredictions()">
            <option value="">å…¨éƒ¨</option>
            <option value="pending">æœªåˆ°æœŸ</option>
            <option value="due">ä»Šæ—¥åˆ°æœŸ</option>
            <option value="overdue">å·²è¿‡æœŸ</option>
            <option value="verified">å·²éªŒè¯</option>
        </select>
        æ’åº:
        <select id="sort-filter" onchange="filterPredictions()">
            <option value="newest">æœ€æ–°</option>
            <option value="oldest">æœ€æ—©</option>
            <option value="likes">ç‚¹èµæ•°</option>
            <option value="confidence">ä¿¡å¿ƒå€¼</option>
        </select>
    </div>
    <div id="global-predictions"></div>
</div>
<div id="my-tab" class="tab-content">
    <div id="my-predictions"></div>
</div>
<div id="create-tab" class="tab-content">
    <h3>å‘å¸ƒæ–°çš„é¢„æµ‹</h3>
    <textarea id="prediction-content" rows="4" cols="50" placeholder="è¾“å…¥ä½ çš„é¢„æµ‹..."></textarea><br>
    åˆ†ç±»:
    <select id="prediction-category">
        <option value="finance">è´¢ç»</option>
        <option value="politics">æ”¿æ²»</option>
        <option value="sports">ä½“è‚²</option>
        <option value="tech">ç§‘æŠ€</option>
        <option value="climate">æ°”å€™</option>
        <option value="other">å…¶ä»–</option>
    </select><br>
    æˆªæ­¢æ—¥æœŸ: <input type="date" id="prediction-date"><br>
    ä¿¡å¿ƒå€¼: <input type="number" id="prediction-confidence" min="1" max="100" value="50">%<br>
    <button onclick="submitPrediction()">æäº¤</button>
</div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyCtShgB65TLqik_EgfYA9hTIwvxnZglpdY",
  authDomain: "forecast-fab55.firebaseapp.com",
  databaseURL: "https://forecast-fab55-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "forecast-fab55",
  storageBucket: "forecast-fab55.firebasestorage.app",
  messagingSenderId: "497230817189",
  appId: "1:497230817189:web:ec30f5f5818e8fd2fc2a4c",
  measurementId: "G-T3BQTYV3FL"
};
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let allPredictions = [];
let myPredictions = JSON.parse(localStorage.getItem('myPredictions') || '[]');
let currentUser = localStorage.getItem('user') || `user_${Date.now()}`;
localStorage.setItem('user', currentUser);

onValue(ref(database, 'predictions'), (snapshot) => {
    const data = snapshot.val();
    allPredictions = data ? Object.values(data) : [];
    updateStats();
    displayPredictions();
});

function savePrediction(prediction) {
    set(ref(database, `predictions/${prediction.id}`), prediction);
}

function submitPrediction() {
    const content = document.getElementById('prediction-content').value.trim();
    const category = document.getElementById('prediction-category').value;
    const dueDate = document.getElementById('prediction-date').value;
    const confidence = parseInt(document.getElementById('prediction-confidence').value);
    if (!content || !dueDate || !confidence) return alert('è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å­—æ®µ');
    const id = Date.now().toString();
    const newPrediction = {
        id,
        userId: currentUser,
        username: currentUser,
        content,
        category,
        dueDate,
        confidence,
        createdAt: new Date().toISOString(),
        likes: [],
        likesCount: 0,
        verified: false
    };
    savePrediction(newPrediction);
    myPredictions.push(newPrediction);
    localStorage.setItem('myPredictions', JSON.stringify(myPredictions));
    switchTab('my');
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
    document.getElementById(`${tabName}-tab`).style.display = 'block';
    if (tabName === 'feed') displayPredictions();
    else if (tabName === 'my') displayMyPredictions();
}

function updateStats() {
    const total = allPredictions.length;
    const verified = allPredictions.filter(p => p.verified).length;
    const today = new Date().toISOString().split('T')[0];
    const todayCount = allPredictions.filter(p => p.createdAt.split('T')[0] === today).length;
    document.getElementById('total-predictions').textContent = total;
    document.getElementById('verified-predictions').textContent = verified;
    document.getElementById('today-predictions').textContent = todayCount;
}

function displayPredictions() {
    const container = document.getElementById('global-predictions');
    const filtered = filterAndSortPredictions(allPredictions);
    container.innerHTML = filtered.length ? filtered.map(p => createPredictionHTML(p, true)).join('') : 'ğŸ“­ è¿˜æ²¡æœ‰é¢„æµ‹';
}

function displayMyPredictions() {
    const container = document.getElementById('my-predictions');
    const myPreds = myPredictions.filter(p => p.userId === currentUser);
    container.innerHTML = myPreds.length ? myPreds.map(p => createPredictionHTML(p, false)).join('') : 'ğŸ“ ä½ è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•é¢„æµ‹';
}

function filterAndSortPredictions(predictions) {
    const category = document.getElementById('category-filter').value;
    const status = document.getElementById('status-filter').value;
    const sort = document.getElementById('sort-filter').value;
    let result = [...predictions];
    if (category) result = result.filter(p => p.category === category);
    if (status) result = result.filter(p => getStatus(p) === status);
    if (sort === 'oldest') result.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));
    else if (sort === 'likes') result.sort((a,b)=>(b.likesCount||0)-(a.likesCount||0));
    else if (sort === 'confidence') result.sort((a,b)=>b.confidence - a.confidence);
    else result.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    return result;
}

function getStatus(pred) {
    const today = new Date().toISOString().split('T')[0];
    if (pred.verified) return 'verified';
    if (pred.dueDate === today) return 'due';
    if (pred.dueDate < today) return 'overdue';
    return 'pending';
}

function createPredictionHTML(pred, showPublic) {
    const status = getStatus(pred);
    const statusMap = { pending: 'æœªåˆ°æœŸ', due: 'ä»Šæ—¥åˆ°æœŸ', overdue: 'å·²è¿‡æœŸ', verified: pred.result ? 'æˆåŠŸ' : 'å¤±è´¥' };
    const classMap = { pending:'status-pending', due:'status-today', overdue:'status-overdue', verified: pred.result?'status-success':'status-fail' };
    const isLiked = pred.likes.includes(currentUser);
    const canVerify = !pred.verified && ['due','overdue'].includes(status) && pred.userId === currentUser;
    return `<div class="prediction-item">
        <h3>${pred.content}</h3>
        <div>ğŸ“… æˆªæ­¢: ${pred.dueDate} ğŸ¯ ä¿¡å¿ƒ: ${pred.confidence}%</div>
        <div class="status-tag ${classMap[status]}">${statusMap[status]}</div>
        <div class="actions">
            ${showPublic ? `<button class="like-btn ${isLiked ? 'liked':''}" onclick="toggleLike('${pred.id}')">â¤ï¸ ${pred.likesCount}</button>`:''}
            ${canVerify ? `<button onclick="verifyPrediction('${pred.id}',true)">âœ… æˆåŠŸ</button><button onclick="verifyPrediction('${pred.id}',false)">âŒ å¤±è´¥</button>`:''}
            ${pred.userId === currentUser ? `<button onclick="deletePrediction('${pred.id}')">ğŸ—‘ï¸ åˆ é™¤</button>`:''}
        </div>
        ${pred.verified ? `<small>éªŒè¯æ—¶é—´: ${formatDate(pred.verifiedAt)}</small>`:''}
    </div>`;
}

function toggleLike(id) {
    const p = allPredictions.find(p => p.id === id);
    if (!p) return;
    const idx = p.likes.indexOf(currentUser);
    if (idx > -1) p.likes.splice(idx,1);
    else p.likes.push(currentUser);
    p.likesCount = p.likes.length;
    savePrediction(p);
}

function verifyPrediction(id, result) {
    const p = allPredictions.find(p => p.id === id);
    if (!p || p.userId !== currentUser) return;
    p.verified = true; p.result = result; p.verifiedAt = new Date().toISOString();
    savePrediction(p);
    myPredictions = myPredictions.map(mp => mp.id === id ? p : mp);
    localStorage.setItem('myPredictions', JSON.stringify(myPredictions));
    alert(`æ ‡è®°ä¸º${result ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
}

function deletePrediction(id) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    remove(ref(database, `predictions/${id}`));
    myPredictions = myPredictions.filter(p => p.id !== id);
    localStorage.setItem('myPredictions', JSON.stringify(myPredictions));
}

function formatDate(s) {
    const d = new Date(s);
    return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
}

window.switchTab = switchTab;
window.toggleLike = toggleLike;
window.verifyPrediction = verifyPrediction;
window.deletePrediction = deletePrediction;
</script>
</body>
</html>
